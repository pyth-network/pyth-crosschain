name: Publish Images to Dockerhub
on:
  release:
    types:
      - created
env:
  DOCKER_HUB: docker.io
  DOCKER_USER: ${{ secrets.DOCKER_IO_USER }}
jobs:
  publish-pyth-price-service:
    name: Publish Pyth price service
    if: ${{ startsWith(github.ref, 'refs/tags/pyth-price-service-v') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Initialize Environment
        run: |
          set -eux
          PREFIX="refs/tags/pyth-price-service-"
          VERSION="${GITHUB_REF:${#PREFIX}}"
          echo "DOCKER_IMAGE=pyth-price-service:${VERSION}" >> "${GITHUB_ENV}"

      - name: Build Docker Image
        run: |
          set -eux
          DOCKER_BUILDKIT=1 docker build -f Dockerfile.wasm -o type=local,dest=. .
          DOCKER_BUILDKIT=1 docker build -t "${DOCKER_IMAGE}" -f \
            third_party/pyth/price-service/Dockerfile.price_service .

      - name: Publish Docker Image
        run: |
          function publish() {
            set -eux
            PUB_IMAGE="${DOCKER_HUB}/${DOCKER_USER}/${DOCKER_IMAGE}"
            docker login "${DOCKER_HUB}" -u "${DOCKER_USER}" --password-stdin
            docker image tag "${DOCKER_IMAGE}" "${PUB_IMAGE}"
            docker image push "${PUB_IMAGE}"
          }
          echo "${{ secrets.DOCKER_IO_PASS }}" | publish
