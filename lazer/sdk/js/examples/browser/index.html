<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Lazer SDK Browser/Worker Example</title>
    <style>
      body { font-family: sans-serif; }
      #logs { background: #f5f5f5; padding: 8px; white-space: pre-wrap; }
      .ok { color: #0a0; }
      .err { color: #a00; }
    </style>
    <script type="importmap">
      {
        "imports": {
          "isomorphic-ws": "./isomorphic-ws.js",
          "@isaacs/ttlcache": "./ttlcache.js",
          "ts-log": "./ts-log.js"
        }
      }
    </script>
  </head>
  <body>
    <h1>Lazer SDK Browser/Worker Example</h1>
    <p>
      Build the SDK (pnpm --filter @pythnetwork/pyth-lazer-sdk run build:esm), then either:
      1) copy ../dist/esm into ./dist/esm (preferred), or
      2) copy ../dist/esm into ./sdk (as ./sdk/index.js, etc.).
      Serve this folder over HTTP and click Start.
    </p>
    <div style="margin: 8px 0; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
      <label>URL <input id="ws" size="60" placeholder="wss://.../v1/stream" /></label>
      <label>Token <input id="token" size="60" placeholder="your access token" /></label>
      <button id="start">Start Worker Test</button>
    </div>
    <div id="logs"></div>
    <script>
      const logs = document.getElementById("logs");
      function log(msg, cls) {
        const d = document.createElement("div");
        if (cls) d.className = cls;
        d.textContent = msg;
        logs.appendChild(d);
      }
      const params = new URL(location.href).searchParams;
      const wsInput = document.getElementById("ws");
      const tokenInput = document.getElementById("token");
      const qpUrl = params.get("url");
      const qpToken = params.get("token");
      if (qpUrl) wsInput.value = qpUrl;
      if (qpToken) tokenInput.value = qpToken;

      document.getElementById("start").onclick = () => {
        const w = new Worker("./worker.js", { type: "module" });
        w.onmessage = (e) => {
          const { type } = e.data || {};
          if (type === "env") {
            const { isNode, hasWebSocket } = e.data;
            log(`Worker env -> isNode: ${String(isNode)}, hasWebSocket: ${String(hasWebSocket)}`);
          } else if (type === "ws_url") {
            log(`Worker WebSocket URL: ${e.data.url}`);
          } else if (type === "ready") {
            log("Worker connected", "ok");
          } else if (type === "msg") {
            log(`Worker message: type=${e.data.msgType}, sample=${e.data.sample}`);
          } else if (type === "done") {
            log("Worker done", "ok");
          } else if (type === "error") {
            const s = e.data.stack ? `\n${e.data.stack}` : "";
            log(`Worker error: ${e.data.error}${s}`, "err");
          }
        };
        w.onerror = (err) => log("Worker onerror: " + err.message, "err");
        const ws = wsInput.value.trim();
        const token = tokenInput.value.trim();
        w.postMessage({ cmd: "start", token, urls: [ws] });
      };
    </script>
  </body>
</html>
